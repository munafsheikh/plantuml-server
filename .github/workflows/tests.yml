name: Tests

on:
  push:
  pull_request:

permissions:
  contents: read

jobs:
  build:
    name: Build (Java ${{ matrix.java-version }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        java-version: [11, 17]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: zulu
          java-version: ${{ matrix.java-version }}
          cache: maven
      - name: Build WAR
        run: mvn --batch-mode --no-transfer-progress clean package
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-war-java-${{ matrix.java-version }}
          path: target/plantuml.war

  build-java-8-war:
    name: Build Java 8 WAR compatibility
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: zulu
          java-version: 8
          cache: maven
      - name: Remove test code (not Java 8 compatible)
        run: rm -rf src/test
      - name: Build Java 8 WAR (with apache-jsp)
        run: mvn --batch-mode --no-transfer-progress -f pom.jdk8.xml -Dapache-jsp.scope=compile clean package
      - name: Upload Java 8 WAR
        uses: actions/upload-artifact@v4
        with:
          name: build-war-java-8
          path: target/plantuml.war

  unit-tests:
    name: Unit/UI tests against embedded server (Java ${{ matrix.java-version }})
    runs-on: ubuntu-latest
    needs: build
    strategy:
      matrix:
        java-version: [11, 17]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: zulu
          java-version: ${{ matrix.java-version }}
          cache: maven
      - name: Run unit + Selenium tests
        run: mvn --batch-mode --no-transfer-progress clean test -DskipTests=false -Dgroups=\!graphviz-test
      - name: Upload surefire reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: surefire-unit-java-${{ matrix.java-version }}
          path: |
            target/surefire-reports
            target/failsafe-reports

  integration-tests-docker:
    name: Docker integration tests (${{ matrix.container }}, Java ${{ matrix.java-version }})
    runs-on: ubuntu-latest
    needs: build
    strategy:
      matrix:
        java-version: [11]
        container: [jetty, tomcat]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: zulu
          java-version: ${{ matrix.java-version }}
          cache: maven
      - name: Prepare tests
        run: mvn --batch-mode --no-transfer-progress clean test
      - name: Build docker image
        run: docker image build -f Dockerfile.${{ matrix.container }} -t plantuml-server:local .
      - name: Start docker image
        run: docker run -d --hostname=test.localhost -p 8080:8080 -e BASE_URL=plantuml plantuml-server:local
      - name: Run external server tests
        run: mvn --batch-mode --no-transfer-progress test -DskipTests=false -DargLine="-Dsystem.test.server=http://localhost:8080/plantuml"
      - name: Upload integration test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: surefire-docker-${{ matrix.container }}
          path: |
            target/surefire-reports
            target/failsafe-reports

  playwright-ui-snapshot:
    name: Playwright UI snapshot test
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: zulu
          java-version: 17
          cache: maven
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install npm dependencies
        run: npm install
      - name: Install Playwright browser
        run: npx playwright install --with-deps chromium
      - name: Start app (Jetty)
        run: mvn --batch-mode --no-transfer-progress -DskipTests=true jetty:run &
      - name: Wait for app startup
        run: |
          for i in {1..60}; do
            if curl -sf http://localhost:8080/plantuml/form >/dev/null; then
              exit 0
            fi
            sleep 2
          done
          echo "Server did not start in time" >&2
          exit 1
      - name: Generate UI snapshots
        run: npm run test:ui:update
      - name: Validate UI snapshots
        run: npm run test:ui
      - name: Upload Playwright artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: |
            playwright-report
            test-results
            tests/playwright/**/*.png

  deploy-results-pages:
    name: Deploy CI results to GitHub Pages
    if: github.event_name == 'push' && github.ref_name == github.event.repository.default_branch
    runs-on: ubuntu-latest
    needs:
      - build
      - build-java-8-war
      - unit-tests
      - integration-tests-docker
      - playwright-ui-snapshot
    permissions:
      pages: write
      id-token: write
      contents: read
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      - name: Build Pages content
        run: |
          mkdir -p site
          {
            echo '<!doctype html><html><head><meta charset="utf-8"><title>PlantUML CI Results</title></head><body>'
            echo '<h1>PlantUML CI Results</h1>'
            echo '<p>Generated from workflow run.</p>'
            echo '<h2>Artifacts</h2><ul>'
            find artifacts -maxdepth 2 -type d | sed '1d' | while read -r d; do
              name=$(basename "$d")
              echo "<li><a href=\"$name/\">$name</a></li>"
            done
            echo '</ul></body></html>'
          } > site/index.html
          find artifacts -mindepth 1 -maxdepth 1 -type d -exec cp -R {} site/ \;
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
